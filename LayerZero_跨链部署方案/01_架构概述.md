# 1. 架构概述

## 1.1 系统架构图

```mermaid
flowchart TB
    subgraph UserLayer["用户层 (User Layer)"]
        WebDApp[Web DApp<br/>前端界面]
        MobileApp[Mobile App<br/>移动应用]
        SDKAPI[SDK/API<br/>开发者集成]
        CLI[CLI Tool<br/>命令行]
    end

    subgraph ContractLayer["智能合约层 (Contract Layer)"]
        subgraph SourceChain["源链 (以太坊/Arbitrum/Optimism)"]
            OFTAdapter[OFTAdapter<br/>• lock/unlock<br/>• 持有原生 USDT]
            SendLib[SendLib ULN302<br/>• 消息打包<br/>• 费用计算<br/>• DVN 配置]
            SrcEndpoint[Endpoint V2<br/>• 消息路由<br/>• nonce 管理]
        end

        subgraph TargetChain["目标链 (Conflux eSpace)"]
            OFT[OFT<br/>• mint/burn<br/>• 管理 USDT0]
            ReceiveLib[ReceiveLib ULN302<br/>• 验证签名<br/>• 确认验证状态<br/>• 触发接收]
            DstEndpoint[Endpoint V2<br/>• 消息接收<br/>• 调用 lzReceive]
            DVNContract[DVN 合约<br/>• 接收签名<br/>• 验证 quorum]
        end
    end

    subgraph VerifyLayer["验证层 (Verification Layer)"]
        subgraph DVNCluster["DVN 集群 (分布式验证网络)"]
            subgraph AWSRegion["AWS 美东区域"]
                DVN1[DVN Node #1<br/>Event Listener<br/>Verifier<br/>Signer HSM]
            end
            subgraph AliyunRegion["阿里云 杭州区域"]
                DVN2[DVN Node #2<br/>Event Listener<br/>Verifier<br/>Signer HSM]
            end
            subgraph GCPRegion["Google 东京区域"]
                DVN3[DVN Node #3<br/>Event Listener<br/>Verifier<br/>Signer HSM]
            end
        end
        SignAgg[签名聚合<br/>阈值签名 2/3]
    end

    subgraph InfraLayer["基础设施层 (Infrastructure Layer)"]
        subgraph BlockchainNodes["区块链全节点集群"]
            Geth[Geth 节点 x3]
            ConfluxNode[Conflux 节点 x3]
            ArbNode[Arbitrum 节点]
            OpNode[Optimism 节点]
        end
        subgraph HSMCluster["HSM 集群"]
            AWSCloudHSM[AWS CloudHSM]
            AliyunKMS[阿里云密钥管理]
            GCPKMS[Google Cloud KMS]
        end
        subgraph Monitoring["监控系统"]
            Prometheus[Prometheus]
            Grafana[Grafana]
            AlertManager[AlertManager]
            ELK[ELK Stack]
        end
    end

    UserLayer --> OFTAdapter
    OFTAdapter --> SrcEndpoint
    SrcEndpoint --> SendLib
    SendLib -.->|PacketSent 事件| DVNCluster
    DVN1 --> SignAgg
    DVN2 --> SignAgg
    DVN3 --> SignAgg
    SignAgg -.->|提交签名| DVNContract
    DVNContract --> ReceiveLib
    ReceiveLib --> DstEndpoint
    DstEndpoint --> OFT
```

---

## 1.2 跨链消息流程

### 1.2.1 完整跨链流程 (以太坊 → Conflux)

```mermaid
sequenceDiagram
    autonumber
    participant User as 用户钱包
    participant USDT as USDT 合约
    participant Adapter as OFTAdapter
    participant Endpoint as Endpoint V2
    participant SendLib as SendLib
    participant DVN1 as DVN #1 (AWS)
    participant DVN2 as DVN #2 (阿里云)
    participant DVN3 as DVN #3 (Google)
    participant DVNContract as DVN 合约
    participant RcvLib as ReceiveLib
    participant DstEnd as 目标 Endpoint
    participant OFT as OFT (USDT0)

    rect rgb(240, 248, 255)
        Note over User,SendLib: Step 1: 用户发起跨链
        User->>USDT: approve(adapter, 100 USDT)
        User->>Adapter: send(dstEid=Conflux, to=用户, amount=100)
        Adapter->>USDT: transferFrom(用户, adapter, 100)
        Note right of Adapter: 锁定 100 USDT
        Adapter->>Endpoint: send(dstEid, message, options)
        Endpoint->>SendLib: send(packet)
        SendLib-->>SendLib: emit PacketSent(nonce, srcEid, dstEid, payload)
    end

    rect rgb(255, 250, 240)
        Note over DVN1,DVN3: Step 2: DVN 监听并验证
        SendLib-->>DVN1: 监听 PacketSent 事件
        SendLib-->>DVN2: 监听 PacketSent 事件
        SendLib-->>DVN3: 监听 PacketSent 事件
        
        Note over DVN1: 等待 12 区块确认
        Note over DVN2: 等待 12 区块确认
        Note over DVN3: 等待 12 区块确认
        
        DVN1->>DVN1: 验证交易 + HSM 签名
        DVN2->>DVN2: 验证交易 + HSM 签名
        DVN3->>DVN3: 验证交易 + HSM 签名
    end

    rect rgb(240, 255, 240)
        Note over DVNContract,OFT: Step 3: 目标链执行
        DVN1->>DVNContract: verifyAndSubmit(header, hash, sigs[])
        Note right of DVNContract: 验证 2/3 签名
        DVNContract->>RcvLib: verify(header, payloadHash, confirmations)
        RcvLib->>RcvLib: 记录验证状态
        
        Note over DstEnd: Executor 调用
        DstEnd->>OFT: lzReceive(origin, guid, message)
        OFT->>OFT: _mint(用户, 100 USDT0)
        Note right of OFT: ✅ 用户收到 100 USDT0
    end
```

### 1.2.2 DVN 验证详细流程

```mermaid
flowchart LR
    subgraph SourceChain["源链"]
        Event[PacketSent 事件]
    end

    subgraph DVNNode["DVN 节点"]
        Listen[事件监听器]
        Wait[等待确认<br/>12 blocks]
        Verify[交易验证]
        Sign[HSM 签名]
    end

    subgraph Aggregator["签名聚合"]
        Collect[收集签名]
        Check{达到 2/3?}
        Submit[提交到目标链]
    end

    subgraph TargetChain["目标链"]
        DVNContract[DVN 合约]
        ReceiveLib[ReceiveLib]
    end

    Event --> Listen
    Listen --> Wait
    Wait --> Verify
    Verify --> Sign
    Sign --> Collect
    Collect --> Check
    Check -->|是| Submit
    Check -->|否| Collect
    Submit --> DVNContract
    DVNContract --> ReceiveLib
```

---

## 1.3 组件职责

| 组件 | 部署位置 | 职责 |
|------|---------|------|
| **OFTAdapter** | 源链 | 锁定/解锁原生代币 |
| **OFT** | 目标链 | 铸造/销毁包装代币 |
| **Endpoint** | 所有链 | 消息路由、nonce 管理 |
| **SendLib** | 源链 | 打包消息、触发事件 |
| **ReceiveLib** | 目标链 | 验证签名、确认消息 |
| **DVN 合约** | 目标链 | 接收并验证 DVN 签名 |
| **DVN 节点** | 链下 | 监听事件、签名验证 |
| **区块链节点** | 链下 | 提供可信数据源 |
| **HSM** | 链下 | 安全存储签名密钥 |

---

## 1.4 安全模型

```mermaid
flowchart TB
    subgraph Threats["威胁"]
        T1[单个 DVN 被攻破]
        T2[RPC 作弊]
        T3[私钥泄露]
        T4[单云服务商故障]
        T5[网络攻击]
        T6[重放攻击]
        T7[内部人员作恶]
    end

    subgraph Protections["防护措施"]
        P1[阈值签名 2/3]
        P2[自建全节点]
        P3[HSM 保护]
        P4[多云部署]
        P5[私有网络 + 无公网 IP]
        P6[nonce 机制]
        P7[多方共管 + 审计日志]
    end

    T1 --> P1
    T2 --> P2
    T3 --> P3
    T4 --> P4
    T5 --> P5
    T6 --> P6
    T7 --> P7
```

### 信任假设

| 假设 | 描述 |
|------|------|
| DVN 诚实性 | 至少 2/3 的 DVN 节点是诚实的 |
| 云服务商隔离 | 各云服务商不会同时被攻破 |
| HSM 安全性 | HSM 硬件是安全的 |
| 数据可信性 | 自建区块链节点数据是可信的 |

---

## 1.5 高可用设计

```mermaid
flowchart TB
    subgraph Region1["AWS 美东 (主)"]
        DVN1[DVN + HSM + 全节点]
    end

    subgraph Region2["阿里云 杭州 (备)"]
        DVN2[DVN + HSM + 全节点]
    end

    subgraph Region3["Google 东京 (备)"]
        DVN3[DVN + HSM + 全节点]
    end

    subgraph SharedState["共享状态"]
        Redis[(Redis Cluster)]
    end

    DVN1 <-->|VPN/专线| DVN2
    DVN2 <-->|VPN/专线| DVN3
    DVN3 <-->|VPN/专线| DVN1

    DVN1 --> Redis
    DVN2 --> Redis
    DVN3 --> Redis

    style Region1 fill:#90EE90
    style Region2 fill:#87CEEB
    style Region3 fill:#FFB6C1
```

### 故障转移策略

| 场景 | 处理方式 |
|------|---------|
| 单个区域故障 | 其他 2 个区域继续运行，满足 2/3 阈值 |
| 单个 DVN 节点故障 | 自动切换到健康节点 |
| HSM 故障 | 使用其他区域 HSM 签名 |
| 区块链节点故障 | 自动切换到备用节点 |

---

## 1.6 数据流架构

```mermaid
flowchart LR
    subgraph DataSources["数据源"]
        ETH[以太坊节点]
        CFX[Conflux 节点]
        ARB[Arbitrum 节点]
    end

    subgraph DVNServices["DVN 服务"]
        Listener[事件监听服务]
        Verifier[验证服务]
        Signer[签名服务]
        Submitter[提交服务]
    end

    subgraph Storage["存储"]
        Redis[(Redis<br/>任务队列)]
        Postgres[(PostgreSQL<br/>审计日志)]
    end

    subgraph HSM["HSM"]
        CloudHSM[密钥存储]
    end

    ETH --> Listener
    CFX --> Listener
    ARB --> Listener
    
    Listener --> Redis
    Redis --> Verifier
    Verifier --> Redis
    Redis --> Signer
    Signer <--> CloudHSM
    Signer --> Redis
    Redis --> Submitter
    Submitter --> CFX
    
    Listener --> Postgres
    Verifier --> Postgres
    Signer --> Postgres
    Submitter --> Postgres
```
